<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chess</title>

<style>
body{
	font-family:Arial;
	background:#f4f4f4;
	display:flex;
	justify-content:center;
	align-items:center;
	height:100vh;
	margin:0
}
.container{
	background:white;
	padding:15px;
	border-radius:10px;
	box-shadow:0 10px 25px rgba(0,0,0,.15);
	text-align:center
}
.board{
	display:grid;
	grid-template-columns:repeat(8,50px);
	grid-template-rows:repeat(8,50px);
	margin:10px auto
}
.cell{
	width:50px;height:50px;
	font-size:30px;
	display:flex;
	justify-content:center;
	align-items:center;
	cursor:pointer
}
.light{background:#f0d9b5}
.darkSquare{background:#b58863}
.highlight{outline:3px solid gold}
.moveHighlight{background:rgba(255,255,0,.5)}
.timer{display:flex;justify-content:space-between;font-weight:bold}
.controls button{margin:5px;padding:6px 10px}
</style>
</head>

<body>
<div class="container">
<h2>Chess</h2>

<div class="timer">
<div id="whiteTimer">White: 05:00</div>
<div id="blackTimer">Black: 05:00</div>
</div>

<div class="board" id="board"></div>
<div id="status">White to move</div>

<div class="controls">
<button onclick="undoMove()">Undo</button>
<button onclick="restart()">Restart</button>
</div>
</div>

<script>
/* ================= STATE ================= */
const boardEl=document.getElementById("board");
const statusEl=document.getElementById("status");
const whiteTimerEl=document.getElementById("whiteTimer");
const blackTimerEl=document.getElementById("blackTimer");

const pieces={r:"♜",n:"♞",b:"♝",q:"♛",k:"♚",p:"♟",R:"♖",N:"♘",B:"♗",Q:"♕",K:"♔",P:"♙"};
const values={p:100,n:320,b:330,r:500,q:900,k:0};

let board,turn="w",selected=null,possibleMoves=[];
let whiteTime=300,blackTime=300,timer=null,gameOver=false;
let history=[];

/* ================= INIT ================= */
function initBoard(){
	board=[
	["r","n","b","q","k","b","n","r"],
	["p","p","p","p","p","p","p","p"],
	["","","","","","","",""],
	["","","","","","","",""],
	["","","","","","","",""],
	["","","","","","","",""],
	["P","P","P","P","P","P","P","P"],
	["R","N","B","Q","K","B","N","R"]
	];
	turn="w";
	selected=null;
	possibleMoves=[];
	whiteTime=300;
	blackTime=300;
	gameOver=false;
	history=[];
	startTimer();
	drawBoard();
	updateTimers();
}

/* ================= TIMER ================= */
function startTimer(){
	clearInterval(timer);
	timer=setInterval(()=>{
		if(gameOver)return;
		turn==="w"?whiteTime--:blackTime--;
		updateTimers();
		if(whiteTime<=0||blackTime<=0){
			gameOver=true;
			statusEl.textContent=whiteTime<=0?"Black wins on time":"White wins on time";
		}
	},1000);
}
const fmt=t=>`${String(t/60|0).padStart(2,"0")}:${String(t%60).padStart(2,"0")}`;
function updateTimers(){
	whiteTimerEl.textContent=`White: ${fmt(whiteTime)}`;
	blackTimerEl.textContent=`Black: ${fmt(blackTime)}`;
}

/* ================= UI ================= */
function drawBoard(){
	boardEl.innerHTML="";
	for(let y=0;y<8;y++)for(let x=0;x<8;x++){
		const c=document.createElement("div");
		c.className="cell "+((x+y)%2?"darkSquare":"light");
		if(selected&&selected.x===x&&selected.y===y)c.classList.add("highlight");
		if(possibleMoves.some(m=>m.x===x&&m.y===y))c.classList.add("moveHighlight");
		c.textContent=pieces[board[y][x]]||"";
		c.onclick=()=>clickCell(x,y);
		boardEl.appendChild(c);
	}
	statusEl.textContent=turn==="w"?"White to move":"Black thinking…";
}

function clickCell(x,y){
	if(gameOver||turn!=="w")return;
	const p=board[y][x];
	if(selected){
		if(possibleMoves.some(m=>m.x===x&&m.y===y)){
			saveState();
			applyMove(board,{x1:selected.x,y1:selected.y,x2:x,y2:y});
			turn="b";
			setTimeout(aiMove,150);
		}
		selected=null;possibleMoves=[];
	}else if(p&&isWhite(p)){
		selected={x,y};
		possibleMoves=getLegalMoves(board,x,y,"w");
	}
	drawBoard();
}

/* ================= HISTORY ================= */
function saveState(){
	history.push({
		board:clone(board),
		turn,whiteTime,blackTime
	});
}

function undoMove(){
	if(!history.length)return;
	const h=history.pop();
	board=h.board;
	turn=h.turn;
	whiteTime=h.whiteTime;
	blackTime=h.blackTime;
	gameOver=false;
	drawBoard();updateTimers();
}

/* ================= AI ================= */
function aiMove(){
	let best=-Infinity,bestMoves=[];
	for(const m of allMoves(board,"b")){
		const b2=clone(board);
		applyMove(b2,m);
		const score=minimax(b2,1,false);
		if(score>best){best=score;bestMoves=[m]}
		else if(score===best)bestMoves.push(m);
	}
	if(!bestMoves.length){gameOver=true;return;}
	saveState();
	applyMove(board,bestMoves[Math.random()*bestMoves.length|0]);
	turn="w";
	drawBoard();
}

function minimax(b,depth,max){
	if(depth===0)return evaluate(b);
	const color=max?"b":"w";
	const moves=allMoves(b,color);
	if(max){
		let v=-Infinity;
		for(const m of moves){
			const b2=clone(b);
			applyMove(b2,m);
			v=Math.max(v,minimax(b2,depth-1,false));
		}
		return v;
	}else{
		let v=Infinity;
		for(const m of moves){
			const b2=clone(b);
			applyMove(b2,m);
			v=Math.min(v,minimax(b2,depth-1,true));
		}
		return v;
	}
}

function evaluate(b){
	let s=0;
	for(const p of b.flat()){
		if(!p)continue;
		s+=isBlack(p)?values[p.toLowerCase()]:-values[p.toLowerCase()];
	}
	return s;
}

/* ================= MOVE GEN ================= */
function allMoves(b,color){
	let r=[];
	for(let y=0;y<8;y++)for(let x=0;x<8;x++){
		const p=b[y][x];
		if(p&&((color==="w"&&isWhite(p))||(color==="b"&&isBlack(p)))){
			getLegalMoves(b,x,y,color).forEach(m=>r.push({x1:x,y1:y,x2:m.x,y2:m.y}));
		}
	}
	return r;
}

function getLegalMoves(b,x,y,color){
	let r=[],p=b[y][x];
	if(!p)return r;
	for(let yy=0;yy<8;yy++)for(let xx=0;xx<8;xx++){
		if(isLegalMove(b,p,x,y,xx,yy)){
			const b2=clone(b);
			applyMove(b2,{x1:x,y1:y,x2:xx,y2:yy});
			if(!kingInCheck(b2,color))r.push({x:xx,y:yy});
		}
	}
	return r;
}

function kingInCheck(b,color){
	const king=color==="w"?"K":"k";
	let kx=-1,ky=-1;
	for(let y=0;y<8;y++)for(let x=0;x<8;x++){
		if(b[y][x]===king){kx=x;ky=y;}
	}
	if(kx===-1)return true;
	for(let y=0;y<8;y++)for(let x=0;x<8;x++){
		const p=b[y][x];
		if(p&&!sameColor(p,king)&&isLegalMove(b,p,x,y,kx,ky))return true;
	}
	return false;
}

/* ================= RULES ================= */
function isLegalMove(b,p,x1,y1,x2,y2){
	if(!p)return false;
	if(x2<0||x2>7||y2<0||y2>7)return false;
	if(x1===x2&&y1===y2)return false;
	const t=b[y2][x2];
	if(t&&sameColor(p,t))return false;
	const dx=x2-x1,dy=y2-y1;
	switch(p.toLowerCase()){
		case"p":return dx===0&&dy==(isWhite(p)?-1:1)&&!t||Math.abs(dx)===1&&dy==(isWhite(p)?-1:1)&&t;
		case"r":return clearLine(b,x1,y1,x2,y2);
		case"b":return Math.abs(dx)===Math.abs(dy)&&clearLine(b,x1,y1,x2,y2);
		case"q":return clearLine(b,x1,y1,x2,y2)&&(dx===0||dy===0||Math.abs(dx)===Math.abs(dy));
		case"n":return Math.abs(dx)*Math.abs(dy)===2;
		case"k":return Math.abs(dx)<=1&&Math.abs(dy)<=1;
	}
	return false;
}

function clearLine(b,x1,y1,x2,y2){
	const dx=Math.sign(x2-x1),dy=Math.sign(y2-y1);
	let x=x1+dx,y=y1+dy;
	while(x!==x2||y!==y2){
		if(x<0||x>7||y<0||y>7)return false;
		if(!b[y])return false;
		if(b[y][x])return false;
		x+=dx;y+=dy;
	}
	return true;
}

/* ================= HELPERS ================= */
const clone=b=>b.map(r=>r.slice());
function applyMove(b,m){
	b[m.y2][m.x2]=b[m.y1][m.x1];
	b[m.y1][m.x1]="";
}
const isWhite=p=>p===p.toUpperCase();
const isBlack=p=>p===p.toLowerCase();
const sameColor=(a,b)=>isWhite(a)===isWhite(b);

/* ================= START ================= */
function restart(){initBoard()}
initBoard();
</script>
</body>
</html>
